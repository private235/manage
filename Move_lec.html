<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6C5CE7;
            --secondary-color: #A29BFE;
            --dark-color: #2D3436;
            --light-color: #F5F6FA;
            --accent-color: #00CE9F;
            --danger-color: #E74C3C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 28px;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ÙÙ„ØªØ±Ø© */
        .filter-panel {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .form-select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 300px;
            max-width: 100%;
        }
        
        /* Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        .main-content {
            display: flex;
            gap: 20px;
            min-height: 70vh;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ© */
        .lecture-list-panel {
            flex: 1;
            background-color: #f0f0f5;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            min-width: 300px;
            max-height: 85vh;
        }

        .panel-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 5px;
        }

        /* Ø­Ø§ÙˆÙŠØ§Øª Ø§Ù„Ø´Ù‡ÙˆØ± */
        .months-container {
            flex: 3;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .month-column {
            background-color: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            min-height: 200px;
            border: 2px dashed transparent;
            transition: background-color 0.2s, border-color 0.2s;
        }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥ÙÙ„Ø§Øª Ø§Ù„Ù†Ø´Ø· */
        .drag-over {
            background-color: #e6e0ff !important;
            border-color: var(--primary-color) !important;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø³Ø­Ø¨ */
        .lecture-item {
            background-color: #fff;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: grab;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            font-weight: 500;
            border-right: 4px solid var(--accent-color);
            transition: opacity 0.2s;
        }

        /* Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ */
        .is-dragging {
            opacity: 0.4;
            border-color: var(--primary-color);
            border-style: solid;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px 0;
            font-size: 14px;
        }
        
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
            text-align: center;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>

    <h2 class="header">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø´Ù‡ÙˆØ±</h2>
    <div id="alert-message"></div>

    <div class="filter-panel">
        <label for="year-selector" style="font-weight: 700; display: block; margin-bottom: 5px;">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</label>
        <select id="year-selector" class="form-select">
            <option value="" disabled selected>--- Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„Ø© ---</option>
            <option value="first">Ø£ÙˆÙ„Ù‰</option>
            <option value="second_chemistry">Ø«Ø§Ù†ÙŠØ© ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
            <option value="second_physics">Ø«Ø§Ù†ÙŠØ© ÙÙŠØ²ÙŠØ§Ø¡</option>
            <option value="third">Ø«Ø§Ù„Ø«Ø©</option>
        </select>
    </div>

    <div class="main-content">
        
        <div class="lecture-list-panel" id="uncategorized-container">
            <div class="panel-title">Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ØµÙ†ÙØ©</div>
            <div id="uncategorized-lectures" class="month-column" data-month-id="uncategorized">
                 <div class="empty-state">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø­Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹...</div>
            </div>
        </div>

        <div class="months-container" id="months-container">
            <div class="empty-state">
                <p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø´Ù‡ÙˆØ± Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</p>
            </div>
        </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

    <script>
        // ==========================================================
        // ========== ØªÙ‡ÙŠØ¦Ø© ÙˆØ¥Ø¹Ø¯Ø§Ø¯ Firebase ÙˆØ§Ù„Ø«ÙˆØ§Ø¨Øª ==========
        // ==========================================================
        
        // **ØªØ¹Ø¯ÙŠÙ„: ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©**
        const firebaseConfig = {
            apiKey: 'AIzaSyBpwRyAO9Hd0y06AFxQP2VJqiwucD02kHE',
            appId: '1:728424288022:web:3fc8d5379263ca3b99ca37',
            messagingSenderId: '728424288022',
            projectId: 'e-learning-3aef4',
            authDomain: 'e-learning-3aef4.firebaseapp.com',
            databaseURL: 'https://e-learning-3aef4-default-rtdb.firebaseio.com',
            storageBucket: 'e-learning-3aef4.firebasestorage.app',
            measurementId: 'G-GTTZ690T29',
        };
        
        if (!firebase.apps.length) {
             firebase.initializeApp(firebaseConfig);
        }

        const database = firebase.database();
        const monthsRef = database.ref('months');
        const lecturesRef = database.ref('lecturess'); // Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª

        const yearSelector = document.getElementById('year-selector');
        const monthsContainer = document.getElementById('months-container');
        const uncategorizedContainer = document.getElementById('uncategorized-lectures');
        const alertMessageDiv = document.getElementById('alert-message');

        let currentYearKey = null;
        let allMonthsData = {}; // {monthId: {name: 'Ø§Ù„Ø§Ø³Ù…', order: 1}}
        let allLecturesData = {}; // {monthId: {lectureId: {data}}}

        const yearKeysDisplayMap = {
            'first': 'Ø£ÙˆÙ„Ù‰',
            'second_chemistry': 'Ø«Ø§Ù†ÙŠØ© ÙƒÙŠÙ…ÙŠØ§Ø¡',
            'second_physics': 'Ø«Ø§Ù†ÙŠØ© ÙÙŠØ²ÙŠØ§Ø¡',
            'third': 'Ø«Ø§Ù„Ø«Ø©'
        };

        function showAlert(message, type = 'success') {
            alertMessageDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                alertMessageDiv.innerHTML = '';
            }, 5000);
        }
        
        // ==========================================================
        // ========== ÙˆØ¸Ø§Ø¦Ù Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
        // ==========================================================
        
        yearSelector.addEventListener('change', fetchDataAndRender);

        async function fetchDataAndRender() {
            currentYearKey = yearSelector.value;
            if (!currentYearKey) return;

            monthsContainer.innerHTML = `<div class="empty-state"><span class="loading-spinner"></span> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± ÙˆØ§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª...</div>`;
            uncategorizedContainer.innerHTML = '';

            try {
                // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ù„Ø³Ù†Ø©
                const monthSnapshot = await monthsRef.child(currentYearKey).once('value');
                const rawMonths = monthSnapshot.val() || {};
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø´Ù‡ÙˆØ± Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù…Ø±ØªØ¨Ø©
                allMonthsData = Object.entries(rawMonths).map(([id, data]) => ({ id, ...data }));
                allMonthsData.sort((a, b) => (a.order || 999) - (b.order || 999));

                // 2. Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù„Ù„Ø³Ù†Ø©
                const lectureSnapshot = await lecturesRef.child(currentYearKey).once('value');
                allLecturesData = lectureSnapshot.val() || {};

                // 3. Ø§Ù„Ø¹Ø±Ø¶
                renderMonths();
                renderLectures();

            } catch (error) {
                console.error("Error fetching data:", error);
                showAlert(`ğŸš« ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`, 'danger');
                monthsContainer.innerHTML = `<div class="empty-state" style="color: var(--danger-color);">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</div>`;
            }
        }

        function renderMonths() {
            if (allMonthsData.length === 0) {
                monthsContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ±/ÙˆØ­Ø¯Ø§Øª Ù…ÙØ¶Ø§ÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.</div>`;
                return;
            }

            monthsContainer.innerHTML = allMonthsData.map(month => `
                <div class="month-column" data-month-id="${month.id}">
                    <div class="panel-title">${month.name || 'Ø´Ù‡Ø± ØºÙŠØ± Ù…Ø³Ù…Ù‰'} (ØªØ±ØªÙŠØ¨: ${month.order || '?'})</div>
                    <div id="month-${month.id}-lectures">
                        </div>
                </div>
            `).join('');
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±
            document.querySelectorAll('.month-column').forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
        }

        function renderLectures() {
            // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹
            allMonthsData.forEach(month => {
                const container = document.getElementById(`month-${month.id}-lectures`);
                if (container) container.innerHTML = '';
            });
            uncategorizedContainer.innerHTML = '';

            let hasLectures = false;

            // ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù…Ø³Ø§Ø± Ø§Ù„Ø³Ù†Ø©
            Object.entries(allLecturesData).forEach(([monthIdOrLectureId, data]) => {
                if (typeof data !== 'object' || data === null) return;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¹Ù‚Ø¯Ø© Ù‡ÙŠ Ø´Ù‡Ø± (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡Ø§)
                const isMonthContainer = allMonthsData.some(m => m.id === monthIdOrLectureId);
                
                if (isMonthContainer) {
                    // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø´Ù‡Ø± Ù…ØµÙ†Ù
                    const lecturesInMonth = data;
                    const containerId = `month-${monthIdOrLectureId}-lectures`;
                    const container = document.getElementById(containerId);
                    
                    if (container) {
                        const lectureList = Object.entries(lecturesInMonth)
                            .map(([lectureId, lectureData]) => ({ lectureId, ...lectureData }))
                            .sort((a, b) => (a.order || 999) - (b.order || 999));
                            
                        container.innerHTML = lectureList.map(lec => createLectureItem(lec.lectureId, lec, monthIdOrLectureId)).join('');
                        if (lectureList.length > 0) hasLectures = true;
                    }
                } else {
                    // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ØºÙŠØ± Ù…ØµÙ†ÙØ© (Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ­Øª Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ù†Ø©)
                    const lectureId = monthIdOrLectureId;
                    const lectureData = data;
                    
                    if (!lectureData.title) return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„ÙØ§Ø±ØºØ© Ø£Ùˆ ØºÙŠØ± Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
                    
                    uncategorizedContainer.innerHTML += createLectureItem(lectureId, lectureData, 'uncategorized');
                    hasLectures = true;
                }
            });

            // Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„Ø© ÙØ§Ø±ØºØ©
            if (!hasLectures) {
                uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©.</div>`;
            } else if (uncategorizedContainer.innerHTML === '') {
                 uncategorizedContainer.innerHTML = `<div class="empty-state">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ØºÙŠØ± Ù…ØµÙ†ÙØ©.</div>`;
            }
        }
        
        function createLectureItem(id, data, parentMonthId) {
            return `
                <div class="lecture-item" 
                     draggable="true" 
                     data-lecture-id="${id}" 
                     data-current-month-id="${parentMonthId}"
                     data-lecture-title="${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}">
                    ${data.title || 'Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'} (#${data.order || '?'})
                </div>
            `;
        }
        
        // ==========================================================
        // ========== ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª (Drag and Drop) ==========
        // ==========================================================
        
        let draggedLecture = null;

        document.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('lecture-item')) {
                draggedLecture = e.target;
                e.dataTransfer.setData('text/plain', e.target.dataset.lectureId);
                e.target.classList.add('is-dragging');
            }
        });

        document.addEventListener('dragend', (e) => {
            if (e.target === draggedLecture) {
                e.target.classList.remove('is-dragging');
                draggedLecture = null;
            }
        });

        function handleDragOver(e) {
            e.preventDefault(); // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥ÙÙ„Ø§Øª
            if (e.target.classList.contains('month-column')) {
                e.target.classList.add('drag-over');
            } else if (e.target.closest('.month-column')) {
                 e.target.closest('.month-column').classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('month-column')) {
                e.target.classList.remove('drag-over');
            } else if (e.target.closest('.month-column')) {
                 e.target.closest('.month-column').classList.remove('drag-over');
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            
            // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥ÙÙ„Ø§Øª
            let dropTarget = e.target.closest('.month-column');
            if (!dropTarget) return; 

            dropTarget.classList.remove('drag-over');
            
            const newMonthId = dropTarget.dataset.monthId;
            const lectureId = e.dataTransfer.getData('text/plain');
            
            if (!lectureId || !draggedLecture) {
                showAlert('Ø®Ø·Ø£ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©.', 'danger');
                return;
            }
            
            const oldMonthId = draggedLecture.dataset.currentMonthId;
            const lectureTitle = draggedLecture.dataset.lectureTitle;

            if (oldMonthId === newMonthId) {
                showAlert('Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.', 'danger');
                return;
            }
            
            // 1. Ù†Ù‚Ù„ Ø§Ù„Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
            const targetContainer = dropTarget.querySelector(`#month-${newMonthId}-lectures`) || dropTarget;
            targetContainer.appendChild(draggedLecture);
            draggedLecture.dataset.currentMonthId = newMonthId;
            
            // 2. ØªØ­Ø¯ÙŠØ« Firebase
            await updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle);
        }
        
        // ==========================================================
        // ========== ÙˆØ¸ÙŠÙØ© ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ==========
        // ==========================================================
        
        async function updateLectureLocation(lectureId, oldMonthId, newMonthId, lectureTitle) {
            if (!currentYearKey) return;

            const isMovingFromUncategorized = oldMonthId === 'uncategorized';
            const isMovingToUncategorized = newMonthId === 'uncategorized';

            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„ÙƒØªØ§Ø¨Ø© ÙˆØ§Ù„Ø­Ø°Ù
            const oldPath = isMovingFromUncategorized 
                            ? `${currentYearKey}/${lectureId}` // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ­Øª Ø§Ù„Ø³Ù†Ø©
                            : `${currentYearKey}/${oldMonthId}/${lectureId}`; // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ØªØ­Øª Ø´Ù‡Ø±
                            
            const newPath = isMovingToUncategorized
                            ? `${currentYearKey}/${lectureId}` // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ­Øª Ø§Ù„Ø³Ù†Ø©
                            : `${currentYearKey}/${newMonthId}/${lectureId}`; // Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ØªØ­Øª Ø´Ù‡Ø±

            showAlert(`Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}"...`, 'success');

            try {
                // 1. Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                const snapshot = await lecturesRef.child(oldPath).once('value');
                const lectureData = snapshot.val();

                if (!lectureData) {
                    throw new Error('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.');
                }
                
                // 2. ØªØ­Ø¯ÙŠØ«/Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                await lecturesRef.child(newPath).set(lectureData);

                // 3. Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø¯ÙŠÙ…
                await lecturesRef.child(oldPath).remove();

                showAlert(`âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "${lectureTitle}" Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ø¶Ù…Ø§Ù† ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª"
                fetchDataAndRender();

            } catch (error) {
                console.error('Firebase Update Error:', error);
                showAlert(`ğŸš« ÙØ´Ù„ Ø§Ù„Ù†Ù‚Ù„: ${error.message}. (ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„Ù†Ù‚Ù„ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Firebase)`, 'danger');
                
                // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ FirebaseØŒ Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ù†ØµØ± Ù„Ù…ÙƒØ§Ù†Ù‡ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                // ÙˆÙ„ÙƒÙ† Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ù‚ÙŠØ¯ØŒ Ù†ÙƒØªÙÙŠ Ø¨Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ ÙˆÙ†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
            }
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ù„Ù…Ù†Ø¹ Ø¸Ù‡ÙˆØ± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„)
        // Ù„Ø§ Ù†Ø­ØªØ§Ø¬ Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ Ø¨Ù„ Ù†Ù†ØªØ¸Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù†Ø©.
    </script>
</body>
</html>